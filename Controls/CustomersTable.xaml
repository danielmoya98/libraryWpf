<UserControl x:Class="library.Controls.CustomersTable"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:models="clr-namespace:library.Models;assembly=library"
             xmlns:converters="clr-namespace:library.Converters"
             xmlns:behaviors="clr-namespace:library.Behaviors"
             x:Name="root">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- Ruta pack al diccionario -->
                <ResourceDictionary Source="../Resources/Themes/CustomersTable.Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Converters locales del control -->
            <converters:InitialsConverter x:Key="Initials" />
            <converters:SafeImageSourceConverter x:Key="SafeImg" />
        </ResourceDictionary>
    </UserControl.Resources>

    <materialDesign:Card Margin="2 0 4 8" Background="White" VerticalAlignment="Stretch"
                         UniformCornerRadius="10" BorderBrush="#E8EDF2" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- HEADER -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Clientes" FontWeight="SemiBold" Margin="10" FontSize="16"
                               Foreground="{StaticResource TitleFg}" />
                    <mah:PackIconMaterial Kind="ArrowTopRight" Width="10" Height="10" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal"
                            HorizontalAlignment="Right" VerticalAlignment="Center" Margin="10">
                    <Button Margin="0,0,8,0"
                            Command="{Binding AddCustomerAsyncCommand,
                  PresentationTraceSources.TraceLevel=High}">
                        <StackPanel Orientation="Horizontal">
                            <mah:PackIconMaterial Kind="AccountPlusOutline" Width="18" Height="18" Margin="0,0,8,0" />
                            <TextBlock Text="Agregar cliente" />
                        </StackPanel>
                    </Button>

                    <Button
                        Command="{Binding DataContext.GenerateCustomersReportCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                        <StackPanel Orientation="Horizontal">
                            <mah:PackIconMaterial Kind="FileChartOutline" Width="18" Height="18" Margin="0,0,8,0" />
                            <TextBlock Text="Generar reporte" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- TABLA -->
            <DataGrid Grid.Row="1"
                      x:Name="GridTable"
                      ItemsSource="{Binding CustomersView}"
                      AutoGenerateColumns="False"
                      VerticalScrollBarVisibility="Hidden"
                      HorizontalScrollBarVisibility="Hidden"
                      VerticalAlignment="Stretch"
                      HorizontalAlignment="Stretch"
                      CanUserAddRows="False" CanUserReorderColumns="False"
                      CanUserResizeColumns="False" CanUserDeleteRows="False"
                      HeadersVisibility="Column" RowHeaderWidth="0"
                      SelectionUnit="FullRow"
                      ColumnHeaderStyle="{StaticResource SlimHeader}"
                      RowStyle="{StaticResource SlimRow}"
                      CellStyle="{StaticResource CenterCell}"
                      HorizontalGridLinesBrush="{StaticResource RowSeparator}"
                      materialDesign:DataGridAssist.CellPadding="12,8"
                      materialDesign:DataGridAssist.ColumnHeaderPadding="12,10"
                      IsReadOnly="True"
                      behaviors:AdaptiveColumnsBehavior.Breakpoints="
                                                                1100:Address;
                                                                1080:Phone;
                                                                980:Email;
                                                                900:Gender;
                                                                840:CI;">

                <DataGrid.Columns>
                    <!-- FOTO -->
                    <DataGridTemplateColumn x:Name="ColPhoto" Header="FOTO" Width="60" CanUserSort="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid Width="32" Height="32" HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <!-- FOTO -->
                                    <Ellipse>
                                        <Ellipse.Style>
                                            <Style TargetType="Ellipse">
                                                <Setter Property="Visibility" Value="Visible" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding PhotoPath}" Value="{x:Null}">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding PhotoPath}" Value="">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Ellipse.Style>
                                        <Ellipse.Fill>
                                            <ImageBrush Stretch="UniformToFill"
                                                        ImageSource="{Binding PhotoPath, Converter={StaticResource SafeImg}}" />
                                        </Ellipse.Fill>
                                    </Ellipse>

                                    <!-- INICIALES (solo si no hay foto) -->
                                    <Border CornerRadius="16" Background="#EEF2F7" BorderBrush="#E2E8F0"
                                            BorderThickness="1">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding PhotoPath}" Value="{x:Null}">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding PhotoPath}" Value="">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <TextBlock Text="{Binding FullName, Converter={StaticResource Initials}}"
                                                   VerticalAlignment="Center" HorizontalAlignment="Center"
                                                   FontWeight="SemiBold" Foreground="#475569" />
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="NOMBRE" SortMemberPath="FirstName"
                                        behaviors:AdaptiveColumnsBehavior.Key="FirstName" Binding="{Binding FirstName}"
                                        ElementStyle="{StaticResource CellTextCenter}" Width="*" />
                    <DataGridTextColumn Header="APELLIDO" SortMemberPath="LastName"
                                        behaviors:AdaptiveColumnsBehavior.Key="LastName" Binding="{Binding LastName}"
                                        ElementStyle="{StaticResource CellTextCenter}" Width="*" />
                    <DataGridTextColumn Header="CI" SortMemberPath="CI" behaviors:AdaptiveColumnsBehavior.Key="CI"
                                        Binding="{Binding CI}"
                                        ElementStyle="{StaticResource CellTextCenter}" Width="*" />
                    <DataGridTextColumn Header="EMAIL" SortMemberPath="Email"
                                        behaviors:AdaptiveColumnsBehavior.Key="Email"
                                        Binding="{Binding Email}"
                                        ElementStyle="{StaticResource CellTextCenter}" Width="2*" />
                    <DataGridTextColumn Header="TELÃ‰FONO" SortMemberPath="Phone"
                                        behaviors:AdaptiveColumnsBehavior.Key="Phone" Binding="{Binding Phone}"
                                        ElementStyle="{StaticResource CellTextCenter}" Width="2*" />
                    <DataGridTextColumn Header="DIRECCIÃ“N" SortMemberPath="Address"
                                        behaviors:AdaptiveColumnsBehavior.Key="Address" Binding="{Binding Address}"
                                        ElementStyle="{StaticResource CellTextCenter}" Width="2*" />

                    <DataGridTemplateColumn Header="GÃ‰NERO" Width="*" SortMemberPath="Gender"
                                            behaviors:AdaptiveColumnsBehavior.Key="Gender">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border>
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <Ellipse Width="8" Height="8" Fill="#64748B" Margin="0 0 6 0" />
                                        <TextBlock Text="{Binding Gender}" FontWeight="SemiBold" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>


                    <DataGridTemplateColumn behaviors:AdaptiveColumnsBehavior.Key="Action" CanUserSort="False"
                                            Header="ACCIÃ“N" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Style="{StaticResource GhostIconButton}" ToolTip="Editar"
                                            Command="{Binding DataContext.EditCustomerCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">

                                        <mah:PackIconMaterial Kind="SquareEditOutline" Width="18" Height="18"
                                                              Foreground="#6B7280" />
                                    </Button>
                                    <Button Style="{StaticResource GhostIconButton}" ToolTip="Eliminar"
                                            Command="{Binding DataContext.DeleteCustomerCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">
                                        <mah:PackIconMaterial Kind="TrashCanOutline" Width="18" Height="18"
                                                              Foreground="#6B7280" />
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>


        </Grid>
    </materialDesign:Card>
</UserControl>