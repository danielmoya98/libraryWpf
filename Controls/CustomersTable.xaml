<UserControl x:Class="library.Controls.CustomersTable"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:models="clr-namespace:library.Models;assembly=library"
             xmlns:converters="clr-namespace:library.Converters"
             xmlns:behaviors="clr-namespace:library.Behaviors"
             x:Name="root">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../Resources/Themes/CustomersTable.Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Converters locales -->
            <converters:InitialsConverter x:Key="Initials" />
            <converters:SafeImageSourceConverter x:Key="SafeImg" />
            <BooleanToVisibilityConverter x:Key="BoolToVis" />
            <converters:VisibilityBooleanConverter x:Key="VisToBool" />
        </ResourceDictionary>
    </UserControl.Resources>


    <!-- TABLA -->
    <DataGrid Grid.Row="1"
              x:Name="GridTable"
              ItemsSource="{Binding CustomersView}"
              AutoGenerateColumns="False"
              VerticalScrollBarVisibility="Auto"
              HorizontalScrollBarVisibility="Disabled"
              VerticalAlignment="Stretch"
              HorizontalAlignment="Stretch"
              CanUserAddRows="False" CanUserReorderColumns="False"
              CanUserResizeColumns="False" CanUserDeleteRows="False"
              HeadersVisibility="Column" RowHeaderWidth="0"
              SelectionUnit="FullRow"
              ColumnHeaderStyle="{StaticResource SlimHeader}"
              CellStyle="{StaticResource CenterCell}"
              HorizontalGridLinesBrush="{DynamicResource RowSeparator}"
              materialDesign:DataGridAssist.CellPadding="12,8"
              materialDesign:DataGridAssist.ColumnHeaderPadding="12,10"
              IsReadOnly="True"
              RowDetailsVisibilityMode="Collapsed"
              ScrollViewer.CanContentScroll="False"
              EnableRowVirtualization="False"
              VirtualizingPanel.IsVirtualizing="False"
              behaviors:AdaptiveColumnsBehavior.Breakpoints="
                        1100:Address;
                        1080:Phone;
                        980:Email;
                        900:Gender;
                        840:CI;">

        <!-- Conservamos tu estilo de fila bÃ¡sico -->
        <DataGrid.RowStyle>
            <Style TargetType="DataGridRow" BasedOn="{StaticResource SlimRow}" />
        </DataGrid.RowStyle>

        <DataGrid.RowDetailsTemplate>
            <DataTemplate>
                <Border Margin="8,0,8,12"
                        Padding="12"
                        CornerRadius="10"
                        Background="{DynamicResource App.ElevatedBrush}"
                        BorderBrush="{DynamicResource App.BorderBrush}"
                        BorderThickness="1"
                        Opacity="0">
                    <Border.Triggers>
                        <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                            <BeginStoryboard>
                                <Storyboard>
                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                     To="1" Duration="0:0:0.18" />
                                </Storyboard>
                            </BeginStoryboard>
                        </EventTrigger>
                    </Border.Triggers>

                    <!-- === Tu contenido de detalle === -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*" />
                            <ColumnDefinition Width="3*" />
                        </Grid.ColumnDefinitions>

                        <!-- Izquierda -->
                        <StackPanel>
                            <TextBlock Text="{Binding FullName}"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource App.TextPrimaryBrush}" />
                            <TextBlock Text="{Binding Email}"
                                       Foreground="{DynamicResource App.TextSecondaryBrush}" />
                            <ItemsControl>
                                <ItemsControl.Items>
                                    <TextBlock Text="{Binding Phone}" />
                                    <TextBlock Text="{Binding Address}" />
                                </ItemsControl.Items>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Derecha -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Style="{StaticResource GhostIconButton}"
                                    ToolTip="Editar"
                                    Command="{Binding DataContext.EditCustomerCommand,
                                                    RelativeSource={RelativeSource AncestorType=DataGrid}}">
                                <mah:PackIconMaterial Kind="SquareEditOutline" Width="18" Height="18" />
                            </Button>
                            <Button Style="{StaticResource GhostIconButton}"
                                    ToolTip="Eliminar"
                                    Command="{Binding DataContext.DeleteCustomerCommand,
                                                    RelativeSource={RelativeSource AncestorType=DataGrid}}">
                                <mah:PackIconMaterial Kind="TrashCanOutline" Width="18" Height="18" />
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
            </DataTemplate>
        </DataGrid.RowDetailsTemplate>


        <DataGrid.Columns>

            <!-- Toggle expandir -->
            <DataGridTemplateColumn Width="44" CanUserSort="False" IsReadOnly="True">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <ToggleButton Width="32" Height="32"
                                      Background="Transparent"
                                      BorderBrush="{DynamicResource App.BorderBrush}"
                                      BorderThickness="1"
                                      ToolTip="Ver detalles"
                                      IsChecked="{Binding Path=DetailsVisibility,
                                  RelativeSource={RelativeSource AncestorType=DataGridRow},
                                  Mode=TwoWay,
                                  Converter={StaticResource VisToBool}}">
                            <ToggleButton.Template>
                                <ControlTemplate TargetType="ToggleButton">
                                    <Border x:Name="bd" CornerRadius="10"
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}">
                                        <mah:PackIconMaterial x:Name="ico" Kind="ChevronRight"
                                                              Width="16" Height="16"
                                                              HorizontalAlignment="Center"
                                                              VerticalAlignment="Center"
                                                              Foreground="{DynamicResource App.IconBrush}" />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="bd" Property="Background"
                                                    Value="{DynamicResource Brush.Hover}" />
                                        </Trigger>
                                        <Trigger Property="IsChecked" Value="True">
                                            <Setter TargetName="ico" Property="Kind" Value="ChevronDown" />
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </ToggleButton.Template>
                        </ToggleButton>

                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- FOTO -->
            <DataGridTemplateColumn x:Name="ColPhoto" Header="FOTO" Width="60" CanUserSort="False">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <Grid Width="32" Height="32" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <!-- foto -->
                            <Ellipse>
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Visibility" Value="Visible" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding PhotoPath}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding PhotoPath}" Value="">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                                <Ellipse.Fill>
                                    <ImageBrush Stretch="UniformToFill"
                                                ImageSource="{Binding PhotoPath, Converter={StaticResource SafeImg}}" />
                                </Ellipse.Fill>
                            </Ellipse>

                            <!-- iniciales -->
                            <Border CornerRadius="16"
                                    Background="{DynamicResource Brush.Hover}"
                                    BorderBrush="{DynamicResource App.BorderBrush}" BorderThickness="1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding PhotoPath}" Value="{x:Null}">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding PhotoPath}" Value="">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding FullName, Converter={StaticResource Initials}}"
                                           VerticalAlignment="Center" HorizontalAlignment="Center"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource App.TextSecondaryBrush}" />
                            </Border>
                        </Grid>
                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <DataGridTextColumn Header="NOMBRE" SortMemberPath="FirstName"
                                behaviors:AdaptiveColumnsBehavior.Key="FirstName"
                                Binding="{Binding FirstName}"
                                ElementStyle="{StaticResource CellTextCenter}" Width="*" />

            <DataGridTextColumn Header="APELLIDO" SortMemberPath="LastName"
                                behaviors:AdaptiveColumnsBehavior.Key="LastName"
                                Binding="{Binding LastName}"
                                ElementStyle="{StaticResource CellTextCenter}" Width="*" />

            <DataGridTextColumn Header="CI" SortMemberPath="CI"
                                behaviors:AdaptiveColumnsBehavior.Key="CI"
                                Binding="{Binding CI}"
                                ElementStyle="{StaticResource CellTextCenter}" Width="*" />

            <DataGridTextColumn Header="EMAIL" SortMemberPath="Email"
                                behaviors:AdaptiveColumnsBehavior.Key="Email"
                                Binding="{Binding Email}"
                                ElementStyle="{StaticResource CellTextCenter}" Width="2*" />

            <DataGridTextColumn Header="TELÃFONO" SortMemberPath="Phone"
                                behaviors:AdaptiveColumnsBehavior.Key="Phone"
                                Binding="{Binding Phone}"
                                ElementStyle="{StaticResource CellTextCenter}" Width="2*" />

            <DataGridTextColumn Header="DIRECCIÃN" SortMemberPath="Address"
                                behaviors:AdaptiveColumnsBehavior.Key="Address"
                                Binding="{Binding Address}"
                                ElementStyle="{StaticResource CellTextCenter}" Width="2*" />

            <DataGridTemplateColumn Header="GÃNERO" Width="*" SortMemberPath="Gender"
                                    behaviors:AdaptiveColumnsBehavior.Key="Gender">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <Border>
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <Ellipse Width="8" Height="8" Fill="{DynamicResource Brush.Icon}"
                                         Margin="0,0,6,0" />
                                <TextBlock Text="{Binding Gender}" FontWeight="SemiBold" />
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- ACCIÃN -->
            <DataGridTemplateColumn behaviors:AdaptiveColumnsBehavior.Key="Action"
                                    CanUserSort="False" Header="ACCIÃN" Width="120">
                <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <Button Style="{StaticResource GhostIconButton}" ToolTip="Editar"
                                    Command="{Binding DataContext.EditCustomerCommand,
                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding}">
                                <mah:PackIconMaterial Kind="SquareEditOutline" Width="18" Height="18"
                                                      Foreground="{DynamicResource Brush.Icon}" />
                            </Button>
                            <Button Style="{StaticResource GhostIconButton}" ToolTip="Eliminar"
                                    Command="{Binding DataContext.DeleteCustomerCommand,
                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding}">
                                <mah:PackIconMaterial Kind="TrashCanOutline" Width="18" Height="18"
                                                      Foreground="{DynamicResource Brush.Icon}" />
                            </Button>
                        </StackPanel>
                    </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

        </DataGrid.Columns>
    </DataGrid>

</UserControl>