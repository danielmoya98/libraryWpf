<UserControl x:Class="library.Controls.SideBar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:conv="clr-namespace:library.Converters"
             xmlns:m="clr-namespace:library.Models"
             x:Name="root"
             Background="Transparent">

  <UserControl.Resources>
    <!-- Oculta textos cuando el sidebar está compacto -->
    <conv:CollapseByWidthToVisibilityConverter x:Key="CollapseToVis" Threshold="120"/>

    <ImageBrush x:Key="LogoBrush"
                ImageSource="pack://application:,,,/library;component/Assets/logazo.png"
                Stretch="Uniform" />
    <ImageBrush x:Key="AvatarBrush"
                ImageSource="pack://application:,,,/library;component/Assets/21249201424022cdd93cd144f099b056.jpg"
                Stretch="UniformToFill" />
      
    <!-- Botón de navegación (pill clara al estar activo) -->
    <Style x:Key="NavButtonStyle" TargetType="Button">
      <Setter Property="Foreground" Value="#16202B"/>
      <Setter Property="Background" Value="Transparent"/>
      <Setter Property="Padding" Value="8"/>
      <Setter Property="Height" Value="40"/>
      <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Border x:Name="bg" Background="Transparent" CornerRadius="10">
              <Grid Margin="6,0">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto"/>
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- ICONO: usa el del item; si es toggle, muestra chevron dinámico -->
                <mah:PackIconMaterial Grid.Column="0" Width="15" Height="15"
                                      VerticalAlignment="Center" Margin="12 0 12 0">
                  <mah:PackIconMaterial.Style>
                    <Style TargetType="{x:Type mah:PackIconMaterial}">
                      <!-- por defecto, el icono del item -->
                      <Setter Property="Kind" Value="{Binding Icon}"/>
                      <Style.Triggers>
                        <!-- si es el toggle y el sidebar está expandido -> ChevronLeft -->
                        <MultiDataTrigger>
                          <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding IsToggle}" Value="True"/>
                            <Condition Binding="{Binding DataContext.IsSidebarExpanded, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True"/>
                          </MultiDataTrigger.Conditions>
                          <Setter Property="Kind" Value="ChevronLeft"/>
                        </MultiDataTrigger>
                        <!-- si es toggle y está colapsado -> ChevronRight -->
                        <MultiDataTrigger>
                          <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding IsToggle}" Value="True"/>
                            <Condition Binding="{Binding DataContext.IsSidebarExpanded, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="False"/>
                          </MultiDataTrigger.Conditions>
                          <Setter Property="Kind" Value="ChevronRight"/>
                        </MultiDataTrigger>
                      </Style.Triggers>
                    </Style>
                  </mah:PackIconMaterial.Style>
                </mah:PackIconMaterial>

                <!-- TÍTULO (se oculta en modo compacto) -->
                <TextBlock Grid.Column="1" Text="{Binding Title}" VerticalAlignment="Center"
                           Visibility="{Binding ElementName=Shell, Path=ActualWidth, Converter={StaticResource CollapseToVis}}"/>
              </Grid>
            </Border>
            <ControlTemplate.Triggers>
              <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="bg" Property="Background" Value="#F1F5F9"/>
              </Trigger>
              <!-- activo -->
              <DataTrigger Binding="{Binding IsActive}" Value="True">
                <Setter TargetName="bg" Property="Background" Value="#E9F2FF"/>
              </DataTrigger>
              <!-- el toggle nunca se pinta como activo -->
              <DataTrigger Binding="{Binding IsToggle}" Value="True">
                <Setter TargetName="bg" Property="Background" Value="Transparent"/>
              </DataTrigger>
            </ControlTemplate.Triggers>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Separador fino -->
    <Style x:Key="ThinSeparator" TargetType="Border">
      <Setter Property="Height" Value="1"/>
      <Setter Property="Margin" Value="12,8"/>
      <Setter Property="Background" Value="#E6EBF0"/>
    </Style>
  </UserControl.Resources>

  <!-- Contenedor principal (ANIMADO) -->
  <Border x:Name="Shell"
          Background="White"
          CornerRadius="10"
          BorderBrush="#DDE3EA" BorderThickness="1"
          Margin="8 7 8 8 "
          SnapsToDevicePixels="True">
    <Border.Style>
      <Style TargetType="Border">
        <Setter Property="Width" Value="64"/>
        <Style.Triggers>
          <DataTrigger Binding="{Binding IsSidebarExpanded}" Value="True">
            <DataTrigger.EnterActions>
              <BeginStoryboard>
                <Storyboard FillBehavior="HoldEnd">
                  <DoubleAnimation Storyboard.TargetProperty="Width"
                                   To="240" Duration="0:0:0.25">
                    <DoubleAnimation.EasingFunction>
                      <CubicEase EasingMode="EaseOut"/>
                    </DoubleAnimation.EasingFunction>
                  </DoubleAnimation>
                </Storyboard>
              </BeginStoryboard>
            </DataTrigger.EnterActions>
            <DataTrigger.ExitActions>
              <BeginStoryboard>
                <Storyboard FillBehavior="HoldEnd">
                  <DoubleAnimation Storyboard.TargetProperty="Width"
                                   To="64" Duration="0:0:0.22">
                    <DoubleAnimation.EasingFunction>
                      <CubicEase EasingMode="EaseInOut"/>
                    </DoubleAnimation.EasingFunction>
                  </DoubleAnimation>
                </Storyboard>
              </BeginStoryboard>
            </DataTrigger.ExitActions>
          </DataTrigger>
        </Style.Triggers>
      </Style>
    </Border.Style>

    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <!-- Header: logo + nombre (sin botón) -->
      <Grid Grid.Row="0" Margin="10,10,10,6">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Border Width="30" Background="{StaticResource LogoBrush}" Height="30" CornerRadius="14" HorizontalAlignment="Left" Margin="5 0 0 0">
        </Border>

        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="5,0,0,0"
                    Visibility="{Binding ElementName=Shell, Path=ActualWidth, Converter={StaticResource CollapseToVis}}">
          <TextBlock Text="Blibioverso" FontWeight="SemiBold" />
        </StackPanel>
      </Grid>

      <!-- Separador -->
      <Border Grid.Row="0" Style="{StaticResource ThinSeparator}" Margin="10,50,10,0"/>

      <!-- Lista de items -->
      <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="4,6">
          <!-- Primarios (incluye el toggle al inicio) -->
          <ItemsControl ItemsSource="{Binding NavItems}">
            <ItemsControl.ItemContainerStyle>
              <Style TargetType="ContentPresenter">
                <Style.Triggers>
                  <DataTrigger Binding="{Binding Section}" Value="{x:Static m:NavSection.Secondary}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </ItemsControl.ItemContainerStyle>
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="{x:Type m:NavigationItem}">
                <Button Style="{StaticResource NavButtonStyle}" Margin="0 2 0 2"
                        Command="{Binding DataContext.ExecuteNavCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        CommandParameter="{Binding}"/>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Separador -->
          <Border Style="{StaticResource ThinSeparator}"/>

          <!-- Secundarios -->
          <ItemsControl ItemsSource="{Binding NavItems}">
            <ItemsControl.ItemContainerStyle>
              <Style TargetType="ContentPresenter">
                <Setter Property="Visibility" Value="Collapsed"/>
                <Style.Triggers>
                  <DataTrigger Binding="{Binding Section}" Value="{x:Static m:NavSection.Secondary}">
                    <Setter Property="Visibility" Value="Visible"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </ItemsControl.ItemContainerStyle>
            <ItemsControl.ItemTemplate>
              <DataTemplate DataType="{x:Type m:NavigationItem}">
                <Button Style="{StaticResource NavButtonStyle}"
                        Command="{Binding DataContext.ExecuteNavCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        CommandParameter="{Binding}"/>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </StackPanel>
      </ScrollViewer>

      <!-- Footer -->
      <Border Grid.Row="2" Background="#FFF" BorderBrush="#E6EBF0" BorderThickness="1,1,0,0"
              CornerRadius="0,0,14,14" Padding="10">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>

          <Ellipse Width="30" Height="30"  Margin="5 0 0 0">
            <Ellipse.Fill>
              <StaticResource ResourceKey="AvatarBrush"/>
            </Ellipse.Fill>
          </Ellipse>
          <StackPanel Grid.Column="1" Margin="8,0,0,0"
                      Visibility="{Binding ElementName=Shell, Path=ActualWidth, Converter={StaticResource CollapseToVis}}">
            <TextBlock Text="Franz Molina" FontWeight="SemiBold" />
            <TextBlock Text="laspitter@gmail.com" Foreground="#7A8894" FontSize="11"/>
          </StackPanel>
        </Grid>
      </Border>
    </Grid>
  </Border>
</UserControl>
