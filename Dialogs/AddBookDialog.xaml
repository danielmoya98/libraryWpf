<UserControl x:Class="library.Dialogs.AddBookDialog"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:converters="clr-namespace:library.Converters"
             MinWidth="560" MaxWidth="720" MaxHeight="525">

  <!-- ========== RESOURCES ========== -->
  <UserControl.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <!-- Tus brushes/estilos base -->
        <ResourceDictionary Source="../Resources/Themes/CustomersTable.Styles.xaml"/>
      </ResourceDictionary.MergedDictionaries>

      <converters:SafeImageSourceConverter x:Key="SafeImg"/>
      <BooleanToVisibilityConverter x:Key="BoolToVis"/>

      <!-- Tarjeta de sugerencia (stretch) -->
      <DataTemplate x:Key="SuggestionCardTemplate">
        <Border Padding="12" Margin="8,6" CornerRadius="12"
                Background="White" BorderBrush="#E5E9F0" BorderThickness="1"
                HorizontalAlignment="Stretch">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="72"/>
              <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Cover -->
            <Border Width="56" Height="84" CornerRadius="6"
                    BorderBrush="#E2E8F0" BorderThickness="1">
              <Border.Background>
                <ImageBrush Stretch="UniformToFill"
                            ImageSource="{Binding CoverPath, Converter={StaticResource SafeImg}}"/>
              </Border.Background>
            </Border>

            <!-- Info + Rating + Botón -->
            <StackPanel Grid.Column="1" Margin="12,2,0,2">
              <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="14"
                         TextTrimming="CharacterEllipsis"/>
              <TextBlock Text="{Binding Author}" Foreground="#64748B" FontSize="12"
                         Margin="0,2,0,6" TextTrimming="CharacterEllipsis"/>

              <StackPanel Orientation="Horizontal">
                <mah:PackIconMaterial Kind="Star" Width="14" Height="14" Foreground="#F59E0B" Margin="0,0,6,0"/>
                <TextBlock Text="{Binding Rating, StringFormat={}{0:0.0}}" Foreground="#111827" FontSize="12"/>
              </StackPanel>

              <Button Margin="0,8,0,0" Padding="10,6" MinWidth="120" HorizontalAlignment="Left"
                      Command="{Binding DataContext.SelectSuggestionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                      CommandParameter="{Binding}">
                <StackPanel Orientation="Horizontal">
                  <mah:PackIconMaterial Kind="PlusBoxOutline" Width="18" Height="18" Margin="0,0,6,0"/>
                  <TextBlock Text="Agregar"/>
                </StackPanel>
              </Button>
            </StackPanel>
          </Grid>
        </Border>
      </DataTemplate>

      <!-- Paso 2: Detalles -->
      <DataTemplate x:Key="DetailsTemplate">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260"/>
            <ColumnDefinition Width="20"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>

          <!-- Portada centrada verticalmente -->
          <Grid Grid.Column="0" VerticalAlignment="Center">
            <Border Width="220" Height="320" CornerRadius="10"
                    BorderBrush="#E2E8F0" BorderThickness="1" Background="#F3F6FA">
              
            </Border>
          </Grid>

          <!-- Formulario -->
          <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>

              <!-- Row 0 -->
              <TextBox Grid.Row="0" Grid.Column="0" Margin="0,0,8,10"
                       materialDesign:HintAssist.Hint="ISBN"
                       Text="{Binding Isbn}"/>
              <TextBox Grid.Row="0" Grid.Column="1" Margin="8,0,0,10"
                       materialDesign:HintAssist.Hint="Año"
                       Text="{Binding Year}"/>

              <!-- Row 1 -->
              <TextBox Grid.Row="1" Grid.Column="0" Margin="0,0,8,10"
                       materialDesign:HintAssist.Hint="Título"
                       Text="{Binding Title}"/>
              <TextBox Grid.Row="1" Grid.Column="1" Margin="8,0,0,10"
                       materialDesign:HintAssist.Hint="Cantidad (stock)"
                       Text="{Binding Stock, UpdateSourceTrigger=PropertyChanged}"/>

              <!-- Row 2: Autor + Nuevo / Calificación -->
              <Grid Grid.Row="2" Grid.Column="0" Margin="0,0,8,10">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0"
                         materialDesign:HintAssist.Hint="Autor"
                         Text="{Binding Author}"/>
                <Button Grid.Column="1" Margin="10,0,0,0"
                        Command="{Binding CreateAuthorCommand}">
                  <StackPanel Orientation="Horizontal">
                    <mah:PackIconMaterial Kind="Plus" Width="16" Height="16" Margin="0,0,6,0"/>
                    <TextBlock Text="Nuevo"/>
                  </StackPanel>
                </Button>
              </Grid>
              <TextBox Grid.Row="2" Grid.Column="1" Margin="8,0,0,10"
                       materialDesign:HintAssist.Hint="Calificación"
                       Text="{Binding Rating}"/>

              <!-- Row 3: Género / Disponible -->
              <ComboBox Grid.Row="3" Grid.Column="0" Margin="0,0,8,10"
                        ItemsSource="{Binding GenreItems}"
                        SelectedValuePath="Key" DisplayMemberPath="Value"
                        SelectedValue="{Binding SelectedGenre, Mode=TwoWay}"
                        materialDesign:HintAssist.Hint="Género"/>
              <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="8,6,0,10">
                <CheckBox IsChecked="{Binding Available}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBlock Text="Disponible" VerticalAlignment="Center"/>
              </StackPanel>

              <!-- Row 4: Editorial / Estado -->
              <TextBox Grid.Row="4" Grid.Column="0" Margin="0,0,8,10"
                       materialDesign:HintAssist.Hint="Editorial"
                       Text="{Binding Publisher}"/>
              <ComboBox Grid.Row="4" Grid.Column="1" Margin="8,0,0,10"
                        ItemsSource="{Binding ConditionItems}"
                        SelectedValuePath="Key" DisplayMemberPath="Value"
                        SelectedValue="{Binding ConditionKey, Mode=TwoWay}"
                        materialDesign:HintAssist.Hint="Estado"/>

              <!-- Row 5: URL imagen -->
              <TextBox Grid.Row="5" Grid.ColumnSpan="2" Margin="0,0,0,10"
                       materialDesign:HintAssist.Hint="URL de la imagen"
                       Text="{Binding CoverUrl, UpdateSourceTrigger=PropertyChanged}"/>

              <!-- Row 6: Sinopsis -->
              <TextBox Grid.Row="6" Grid.ColumnSpan="2" Height="100"
                       AcceptsReturn="True" TextWrapping="Wrap"
                       materialDesign:HintAssist.Hint="Sinopsis"
                       Text="{Binding Synopsis}"/>

              <!-- Row 7: Distribución por estado (salta al paso 3) -->
              <Button Grid.Row="7" Grid.ColumnSpan="2" Margin="0,10,0,0"
                      Command="{Binding OpenDistributionCommand}">
                <StackPanel Orientation="Horizontal">
                  <mah:PackIconMaterial Kind="TransitConnectionVariant" Width="18" Height="18" Margin="0,0,8,0"/>
                  <TextBlock Text="Distribución por estado"/>
                </StackPanel>
              </Button>
            </Grid>
          </ScrollViewer>
        </Grid>
      </DataTemplate>

      <!-- Paso 3: Distribución por estado -->
      <DataTemplate x:Key="DistributionTemplate">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="20"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>

          <!-- Campos de distribución -->
          <StackPanel Grid.Column="0">
            <TextBox Margin="0,0,0,10" materialDesign:HintAssist.Hint="Nuevo"
                     Text="{Binding DistNew, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBox Margin="0,0,0,10" materialDesign:HintAssist.Hint="Usado"
                     Text="{Binding DistUsed, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBox Margin="0,0,0,10" materialDesign:HintAssist.Hint="Desgastado"
                     Text="{Binding DistWorn, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBox Margin="0,0,0,10" materialDesign:HintAssist.Hint="Dañado"
                     Text="{Binding DistDamaged, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBox Margin="0,0,0,10" materialDesign:HintAssist.Hint="Reparado"
                     Text="{Binding DistRepaired, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBox Margin="0,0,0,10" materialDesign:HintAssist.Hint="En restauración"
                     Text="{Binding DistRestoring, UpdateSourceTrigger=PropertyChanged}"/>
          </StackPanel>

          <!-- Resumen -->
          <Border Grid.Column="2" Padding="16" CornerRadius="10" BorderBrush="#E5E9F0" BorderThickness="1">
            <StackPanel>
              <TextBlock Text="Resumen" FontWeight="SemiBold" Margin="0,0,0,10"/>

              <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                <TextBlock Text="Stock declarado:" Width="150" Foreground="#64748B"/>
                <TextBlock Text="{Binding Stock, Mode=OneWay}" FontWeight="SemiBold"/>
              </StackPanel>

              <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                <TextBlock Text="Total asignado:" Width="150" Foreground="#64748B"/>
                <!-- OneWay: propiedad de solo lectura -->
                <TextBlock Text="{Binding DistTotal, Mode=OneWay}" FontWeight="SemiBold"/>
              </StackPanel>

              <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                <TextBlock Text="Diferencia:" Width="150" Foreground="#64748B"/>
                <!-- OneWay -->
                <TextBlock Text="{Binding DistDiff, Mode=OneWay}" FontWeight="SemiBold"/>
              </StackPanel>

              <TextBlock Margin="0,8,0,0" FontSize="12"
                         Text="La diferencia debe ser 0 para poder guardar."
                         Foreground="#9AA3AE"/>
            </StackPanel>
          </Border>
        </Grid>
      </DataTemplate>

    </ResourceDictionary>
  </UserControl.Resources>

  <!-- ========== CONTENT ========== -->
  <Border Padding="22" Background="White">
    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <!-- Título -->
      <TextBlock Grid.Row="0" Text="Agregar libro"
                 FontSize="20" FontWeight="SemiBold" Foreground="#243147" Margin="4,0,4,10"/>

      <!-- Stepper -->
      <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8">
        <TextBlock Text="1. Buscar" Margin="0,0,10,0" VerticalAlignment="Center">
          <TextBlock.Style>
            <Style TargetType="TextBlock">
              <Setter Property="Foreground" Value="#475569"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding StepIndex}" Value="0">
                  <Setter Property="Foreground" Value="#5B6BFE"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </TextBlock.Style>
        </TextBlock>

        <mah:PackIconMaterial Kind="ChevronRight" Width="18" Height="18" VerticalAlignment="Center"
                              Foreground="#9AA3AE" Margin="0,0,8,0"/>

        <TextBlock Text="2. Detalles" Margin="0,0,10,0" VerticalAlignment="Center">
          <TextBlock.Style>
            <Style TargetType="TextBlock">
              <Setter Property="Foreground" Value="#475569"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding StepIndex}" Value="1">
                  <Setter Property="Foreground" Value="#5B6BFE"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </TextBlock.Style>
        </TextBlock>

        <mah:PackIconMaterial Kind="ChevronRight" Width="18" Height="18" VerticalAlignment="Center"
                              Foreground="#9AA3AE" Margin="0,0,8,0"/>

        <TextBlock Text="3. Distribución" VerticalAlignment="Center">
          <TextBlock.Style>
            <Style TargetType="TextBlock">
              <Setter Property="Foreground" Value="#475569"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding StepIndex}" Value="2">
                  <Setter Property="Foreground" Value="#5B6BFE"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </TextBlock.Style>
        </TextBlock>
      </StackPanel>

      <!-- Contenido con transición -->
      <materialDesign:Transitioner Grid.Row="2" SelectedIndex="{Binding StepIndex}">
        <!-- Paso 1 -->
        <materialDesign:TransitionerSlide>
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Buscador -->
            <Border Grid.Row="0" Background="#F1F5F9" CornerRadius="10" Padding="12"
                    BorderBrush="#E2E8F0" BorderThickness="1" Margin="0,0,0,10">
              <DockPanel LastChildFill="True">
                <mah:PackIconMaterial Kind="Magnify" Width="20" Height="20" Foreground="#64748B" Margin="0,0,8,0"/>
                <TextBox BorderThickness="0" Background="Transparent" Foreground="#111827"
                         FontSize="14"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         materialDesign:HintAssist.Hint="Buscar título, autor o ISBN…"/>
              </DockPanel>
            </Border>

            <!-- Lista de sugerencias -->
            <ListBox Grid.Row="1"
                     ItemsSource="{Binding SuggestionsView}"
                     ItemTemplate="{StaticResource SuggestionCardTemplate}"
                     BorderThickness="0" Background="Transparent"
                     ScrollViewer.VerticalScrollBarVisibility="Auto">
              <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                  <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                  <Setter Property="Padding" Value="0"/>
                  <Setter Property="Focusable" Value="False"/>
                </Style>
              </ListBox.ItemContainerStyle>
            </ListBox>
          </Grid>
        </materialDesign:TransitionerSlide>

        <!-- Paso 2 -->
        <materialDesign:TransitionerSlide>
          <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource DetailsTemplate}"/>
        </materialDesign:TransitionerSlide>

        <!-- Paso 3 -->
        <materialDesign:TransitionerSlide>
          <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource DistributionTemplate}"/>
        </materialDesign:TransitionerSlide>
      </materialDesign:Transitioner>

      <!-- Footer -->
      <DockPanel Grid.Row="3" LastChildFill="False" Margin="0,16,0,0">

        <!-- Atrás (visible en pasos 1 y 2) -->
        <Button DockPanel.Dock="Left" Command="{Binding BackCommand}">
          <Button.Style>
            <Style TargetType="Button">
              <Setter Property="Visibility" Value="Collapsed"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding StepIndex}" Value="1">
                  <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding StepIndex}" Value="2">
                  <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </Button.Style>
          <StackPanel Orientation="Horizontal">
            <mah:PackIconMaterial Kind="ArrowLeft" Width="18" Height="18" Margin="0,0,8,0"/>
            <TextBlock Text="Atrás"/>
          </StackPanel>
        </Button>

        <!-- Guardar (visible en pasos 1 y 2; Step 2 exige diferencia=0) -->
        <Button DockPanel.Dock="Right"
                IsEnabled="{Binding CanSave}"
                Command="{x:Static materialDesign:DialogHost.CloseDialogCommand}"
                CommandParameter="{Binding}">
          <Button.Style>
            <Style TargetType="Button">
              <Setter Property="Visibility" Value="Collapsed"/>
              <Style.Triggers>
                <DataTrigger Binding="{Binding StepIndex}" Value="1">
                  <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding StepIndex}" Value="2">
                  <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </Button.Style>
          <StackPanel Orientation="Horizontal">
            <mah:PackIconMaterial Kind="ContentSaveOutline" Width="18" Height="18" Margin="0,0,8,0"/>
            <TextBlock Text="Guardar"/>
          </StackPanel>
        </Button>

        <!-- Cancelar (solo paso 0) -->
        <Button DockPanel.Dock="Right" Margin="8,0,0,0"
                Visibility="{Binding IsStepSearch, Converter={StaticResource BoolToVis}}"
                Command="{x:Static materialDesign:DialogHost.CloseDialogCommand}"
                CommandParameter="{x:Null}">
          <StackPanel Orientation="Horizontal">
            <mah:PackIconMaterial Kind="Close" Width="18" Height="18" Margin="0,0,8,0"/>
            <TextBlock Text="Cancelar"/>
          </StackPanel>
        </Button>

      </DockPanel>

    </Grid>
  </Border>
</UserControl>
